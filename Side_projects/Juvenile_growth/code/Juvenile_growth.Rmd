---
title: "Juvenile Growth"
author: 
date: "6/20/2024"
output: html_document

description: This code is for the Juvenille Growth Study looking at growth rates and survival of 1 year old spat produced from the natural oyster bed at Ash Creek. The spat were divided into replicates of 3 spat bags with 100 individuals per bag and placed at Ash Creek, Fairfield CT and Fence Creek, Madison CT. The goal is to compare growth and survival at each site and determine if and what environmental factors may influence the population. 

Important Notes: Fence Creek 06/10/24 measurements for height after individual 50 were deleted/lost due to tablet glitch. Total counts should be based on the survival metric taken to determine live counts. 

---
Last updated 08/6/24 by M.Kachmar
  - reorganized the files to now have monthly measurements that will be merged like how our other data is set up
  - started to redo some of the code below to give metrics that we want
  
 

```{r setup, include=FALSE}
#make sure that your path is not commented (#) out and all others are
#this shows the path that R will take to find the data within your files on your computer

knitr::opts_chunk$set(echo = TRUE) 
#knitr::opts_knit$set(root.dir = 'C:/Users/kennedy.mcgrath/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kennedy's
knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
#knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
#knitr::opts_knit$set(root.dir = 'C:/Users/kelly.roper/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kelly's
#knitr::opts_knit$set(root.dir = 'C:/Users/katherine.mcfarland/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Katie's
```


```{r,echo = FALSE}
#this code loads all packages that the code will need
#make sure all packages are installed before running this code
library("ggplot2")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library("tidyr")
```

### This code chunk merges all .csv files within the Tissue processing folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}
#Collecting and merging all raw data
data_all <- list.files(path = "Side_projects/Juvenile_growth/raw_data",  #path in files
                       pattern = "*.csv" #calling all csv files
                       , full.names = TRUE)%>% lapply(read_csv) %>% bind_rows() #combines all raw data from the path/folder into one tibble
data_all

as.data.frame(data_all)  # Convert tibble to data.frame. This helps when working with raw date

data_all <- data_all %>% filter(!is.na(Date))  #filtering NAs only in column "Date"

data_all <- data_all %>% select(where(~ !all(is.na(.)))) #removing excess columns with NA


write.csv(data_all, "Master_files\\juv_growth_all_data.csv", row.names=FALSE)  #creating/printing csv file of all raw data merged together
```

#This code chunk with specify to R the order in which you want month presented. When not using a data and grouping by month, the default is to put in alphabetical order, this chuck will correct that. 

#This code chunk is not working. it is reading the format as dd/mm/yy instead of mm/dd/yy and giving a month associated with the date. 
```{r}
#The dates in the data files are reading as a character "chr" so we need to change them to date format

data_all <- data_all %>% dplyr::mutate(Date= as.Date(Date), Month = month(Date))



#changing numeric month to month name
data_all$Month <- factor(data_all$Month, levels = c("1","2","3","4","5","6","7", "8", "9", "10", "11", "12"),
        labels=c("Jan","Feb", "March","April","May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"))

data_all

```


```{r}
# Summary of all data

st_height <- summarySE(data_all%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date"))

st_height 


```
#Survival

```{r}
#Sum total number of live oysters per shell bag per date
spatbag_counts<- data_all %>%
  dplyr::group_by(Bag_number, Survival, Site, Date) %>%
  dplyr::summarize(Count = n())
spatbag_counts

#summary of each oyster type by site. output = Site, N, Mean, stnd dev, stnd error, and confidence interval
all_density_SE <-summarySE(data = quadratdensity_all, measurevar = "Count", groupvars=c("Site", "Survival_status", "Season", "Date_collected"))
all_density_SE

#calculate percent standard error as 100*se/mean
all_density_SE$PSE_all <- 100*(all_density_SE$se/all_density_SE$Count)

#calculate completeness as 100*N/4, where 4 is the desired number of quadrats per site. 2023 surveys had 12 quadrates measured. 
  densitysummary <- all_density_SE %>%
    mutate(PercentComplete_Quad = ((N/4)*100))
densitysummary


write_csv(densitysummary, "Field_Data_Biological/output/populationdensity_summary.csv") #, row.names=FALSE)
```

```{r}
counts <- list.files(path = "Side_projects/Juvenile_growth",  #need to have file with data in "raw_data"\
                       pattern = "*.csv", full.names = TRUE)%>% lapply(read_csv) %>% bind_rows()
counts

### Fence creek ###
FENC_counts_all <- counts %>%
  dplyr::filter(Site == "FENC")%>%
  dplyr::group_by(Date)%>%
  dplyr::summarize(total = sum(Live_Count))
  
FENC_counts_all

FENC_counts_June <- FENC_counts_all %>% filter(Date == "6/10/2024")
FENC_counts_July <- FENC_counts_all %>% filter(Date == "7/10/2024")

# % survival between June and July

FENC_total_surv <- (FENC_counts_July$total/FENC_counts_June$total)*100
FENC_total_surv


### Ash creek ###
ASHC_counts_all <- counts %>%
  dplyr::filter(Site == "ASH")%>%
  dplyr::group_by(Date)%>%
  dplyr::summarize(total = sum(Live_Count))
  
ASHC_counts_all

ASHC_counts_June <- ASHC_counts_all %>% filter(Date == "6/10/2024")
ASHC_counts_July <- ASHC_counts_all %>% filter(Date == "7/10/2024")

# % survival between June and July

ASHC_total_surv <- (ASHC_counts_July$total/ASHC_counts_June$total)*100
ASHC_total_surv

# % survival per bag

```


```{r}
ggplot(data=data_all, aes(x=Site, y=Shell_Height, fill=Site)) +
  geom_boxplot()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Mean Shell Height ", x ="Site", y = "Mean Shell Height (mm)") +
  facet_wrap(~Month)
```
Based on the graph above, it looks like we have greater shell growth at FENCE, so 


```{r}

```


```{r}
ggplot(data=data_all, aes(x=Shell_Height)) +
  geom_histogram()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Juvenile Shell Height", x ="Height (mm)")+ scale_x_continuous(limits= c(0,80), breaks = seq(0,80, by =5) )+
  scale_y_continuous(limits = c(0,70), breaks = seq(0,70, by = 5))+
 facet_wrap(~ Site + Month, scales = "free", ncol = 1)
# add date to facet wrap after July collection
```


# Read in a summary file for counts and growth rate. Normally we would build code that does this for us, but to ensure you have plots to work with for your presenations, we will use this work around. 

```{r}
df<-read.csv("Side_projects/Juvenile_growth/summary_count_data.csv", header = T) #calling out path to read file
#$Survival=as.numeric(df$Survival)
```
```{r}
df2 <- df%>%na.omit(Survival) #removing rows within data frame that have NAs in Survival column
df2

survival_sum <- summarySE(df2, "Survival", groupvars=c("Site")) #creating stats (sd, se, ci) about data
survival_sum
```

```{r}
#This chunk is creating a ggplot of the data
prop.survived <- ggplot(data=survival_sum, aes(x=Site, y=Survival, fill=Site))+ #describe what data frame to use and the what rows should be on the x and y axis. Fill is the data that color codes the individual bars
geom_col(color = "black", linewidth =  0.75) + #codes the outline of the bars
geom_bar(stat="identity")+ #defines the type of graph to be bar
geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2, position=position_dodge(.9))+ #adds error bars previously calculated
theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ #removing grid lines
scale_fill_manual(values = c("orange1", "cornflowerblue") )+ #filling bars with specific colors
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ #can adjust angle of axis text
labs(x ="Site", y = "Propotion Survived") +
#facet_wrap(~Date)+ # could add a facet_wrap for date but would need to add to data frame first
theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150), legend.text = element_text(size = 13), legend.title = element_text(size = 19))+
#changes axis and legend text and title, also plot.margin removes the white space within the graph
  ylim(0,1) #restrcting y axis limits from 0 to 1
prop.survived
```
```{r}
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"NEWprop_survived2024.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(prop.survived) #specify the graph
dev.off()
```

#Look at previous graph's code for a description of each line when creating a ggplot graph
```{r}
growth.rate <- ggplot(data=df, aes(x=Site, y=GR_mergedT0, fill=Site)) +
  geom_boxplot(width = 2)+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_fill_manual(values = c("orange1", "cornflowerblue") )+
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(x ="Site", y = "Growth Rate (mm / month)") +
# could add a facet_wrap for date
  theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150))+
  ylim(0,16)
  

growth.rate
```

# use to save indivdual graphs as a pdf in the outputs folder. must make graph an object first
```{r}
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"NEWgrowthrate2024.pdf"), height = 7, width = 11)
print(growth.rate)
dev.off()
```


Testing assumptions for statistical analysis (Survival and Growth rate)

  #### Code not working - resume edits here (km, 7/14/2024).
```{r}
library(rstatix)

leveneTest(Survival ~ Site, data=df)
shapiro.test(df$Survival)

leveneTest(Growth_rate ~ Site, data=df
shapiro.test(df$Growth_rate)
```


```{r}
sessionInfo()
```


