---
title: "Juvenile Growth"
author: Kyra Lenderman + Mariah Kachmar
date: "6/20/2024"
output: html_document

description: This code is for the Juvenille Growth Study looking at growth rates and survival of ~1 year old spat produced from the natural oyster bed at Ash Creek. The spat were divided into replicates of 3 spat bags with 100 individuals per bag and placed at Ash Creek, Fairfield CT and Fence Creek, Madison CT. The goal is to compare growth and survival at each site and determine if and what environmental factors may influence the population. 

Important Notes: Fence Creek 06/10/24 measurements for height after individual 50 were deleted/lost due to tablet glitch. Total counts should be based on the survival metric taken to determine live counts. 

---
Last updated 10/31/24 by M.Kachmar
- calculated growth rate & graphed, I think? Need someone to check the math. I combined June to be t0 to do these calculations. 
- also need to standardize to 30 day time lapse??
- Updated Kaplan Meier survival
  
 

```{r setup, include=FALSE}
#make sure that your path is not commented (#) out and all others are
#this shows the path that R will take to find the data within your files on your computer

knitr::opts_chunk$set(echo = TRUE) 
#knitr::opts_knit$set(root.dir = 'C:/Users/kennedy.mcgrath/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kennedy's
#knitr::opts_knit$set(root.dir = 'C:/Users/mariah.kachmar/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Mariah's
knitr::opts_knit$set(root.dir = 'C:/Users/kyra.lenderman/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kyra's
#knitr::opts_knit$set(root.dir = 'C:/Users/kelly.roper/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Kelly's
#knitr::opts_knit$set(root.dir = 'C:/Users/katherine.mcfarland/Documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance') #Katie's
```


```{r,echo = FALSE}
#this code loads all packages that the code will need
#make sure all packages are installed before running this code
library("ggplot2")
library("ggpubr")
library("readxl")
library("plyr")                                     
library("dplyr")
library("Rmisc")
library("readr")  
library("lubridate")
library("purrr")
library("tidyr")
library("survminer")
library("survival")
library("ggpubr")
```

### This code chunk merges all .csv files within the Tissue processing folder into one data fram and outputs the full dataset into a .csv master file. This allows us to download the raw data as a .csv, add it to the repository folder, and create the master data file without copying and pasting data in excel.
# reading in .csv files from local folder
```{r}
#Collecting and merging all raw data

file_paths <- list.files(path = "Side_projects/Juvenile_growth/raw_data",
                          pattern = "*.csv", full.names = TRUE)


data_all <- lapply(file_paths, function(file_path) {
  read_csv(file_path) %>%
    mutate(
      Date = as.Date(Date,format = "%m/%d/%Y"))
}) %>%
  bind_rows

as.data.frame(data_all)  # Convert tibble to data.frame

View(data_all)

data_all <- data_all %>% filter(!is.na(Date))  #filtering NAs only in column "Date"

data_all <- data_all %>% select(where(~ !all(is.na(.)))) #removing excess columns with NA



write.csv(data_all, "Master_files\\juv_growth_all_data.csv", row.names=FALSE)  #creating/printing csv file of all raw data merged together
```

#This code chunk with specify to R the order in which you want month presented. When not using a data and grouping by month, the default is to put in alphabetical order, this chuck will correct that. 

```{r}
#The dates in the data files are reading as a character "chr" so we need to change them to date format

data_all <- data_all %>% dplyr::mutate(Month = month(Date,label = TRUE, abbr = FALSE))



#changing numeric month to month name
#data_all$Month <- factor(data_all$Month, levels = c("1","2","3","4","5","6","7", "8", "9", "10", "11", "12"),
    #    labels=c("Jan","Feb", "March","April","May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"))

#data_all





```


```{r}
# Summary of all height data

st_height <- summarySE(data_all%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))

st_height 


#Summary of all height data per bag

st_height_bag <- summarySE(data_all%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))

st_height_bag 
```
#Let's take a look at the data - Shell length! 
```{r}

st_height$Site< - as.factor(st_height$Site) 
str(st_height)

ggplot(data=st_height, aes(x=Month, y=Shell_length, fill=Site)) +
                 geom_point()
```



```{r}
#Average shell height per month per site

ggplot(data=data_all, aes(x=Site, y=Shell_length, fill=Site)) +
  geom_boxplot()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Mean Shell Height ", x ="Site", y = "Mean Shell Height (mm)") +
  facet_wrap(~Month, ncol = 5)
```
```{r}
#Average shell height per month per site

ggplot(data=data_all, aes(x=Month, y=Shell_length, fill=Site)) +
  geom_boxplot()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Mean Shell Height ", x ="Site", y = "Mean Shell Height (mm)")
```

```{r}
# size class distribution graph per site per month

ASHC<- data_all %>% filter(Site %in% c("ASHC"))
FENC<- data_all %>% filter(Site %in% c("FENC"))

ggplot(data=ASHC, aes(x=Shell_length)) +
  geom_histogram()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Juvenile Shell Height - Ash Creek", x ="Height (mm)")+ scale_x_continuous(limits= c(0,80), breaks = seq(0,80, by =5) )+
  scale_y_continuous(limits = c(0,70), breaks = seq(0,70, by = 5))+
 facet_wrap(~ Month, scales = "free", ncol = 1)
# add date to facet wrap after July collection

ggplot(data=FENC, aes(x=Shell_length)) +
  geom_histogram()+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title="Juvenile Shell Height - Fence Creek", x ="Height (mm)")+ scale_x_continuous(limits= c(0,80), breaks = seq(0,80, by =5) )+
  scale_y_continuous(limits = c(0,70), breaks = seq(0,70, by = 5))+
 facet_wrap(~ Month, scales = "free", ncol = 1)
```

#Mortality calculations
```{r}
#Lets great some summaries to see numbers and calculate the survival %
#Create a summary of counts across all bags
Survival_counts_all <- data_all %>% 
  dplyr::group_by(Site, Date, Survival) %>% 
  dplyr::summarise(count = n())
Survival_counts_all

#Create a summary of counts per bag
Survival_counts_bag <- data_all %>% 
  dplyr::group_by(Site, Date, Survival, Bag_number) %>% 
  dplyr::summarise(count = n())
Survival_counts_bag

#Survival summary
survival_sum_all <- summarySE(data_all, "Survival", groupvars=c("Site", "Date")) #creating stats (sd, se, ci) about data
survival_sum_all


```
#Proportions of survival - graphing survival summary
```{r}
#This chunk is creating a ggplot of the data
prop.survived <- ggplot(data=survival_sum_all, aes(x=Site, y=Survival, fill=Site))+ #describe what data frame to use and the what rows should be on the x and y axis. Fill is the data that color codes the individual bars
geom_col(color = "black", linewidth =  0.75) + #codes the outline of the bars
geom_bar(stat="identity")+ #defines the type of graph to be bar
geom_errorbar(aes(ymin=Survival-se, ymax=Survival+se), width=.2, position=position_dodge(.9))+ #adds error bars previously calculated
theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ #removing grid lines
scale_fill_manual(values = c("orange1", "cornflowerblue") )+ #filling bars with specific colors
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ #can adjust angle of axis text
labs(x ="Site", y = "Propotion Survived") +
#facet_wrap(~Date)+ # could add a facet_wrap for date but would need to add to data frame first
theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150), legend.text = element_text(size = 13), legend.title = element_text(size = 19))+
#changes axis and legend text and title, also plot.margin removes the white space within the graph
  ylim(0,1) #restrcting y axis limits from 0 to 1
prop.survived


#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"NEWprop_survived2024.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(prop.survived) #specify the graph
dev.off()
```

#Calculating Growth Rate
#Reading this paper : Osei et al. 2022 - "monthly growth rate = (H2 âˆ’ H1)/(t/30), where H1 is initial shell height (cm), H2 is final shell height (cm) and t is the number days between sampling" - how to tell R to do this?
#Is the correct? I am not sure - needs to be checked over and adjusted. I have it a whirl LOL - MK

#GR = ((Ht2 - Ht1 )/ (t2-t1)) x 30 growth rate standaridized in mm / month (to a 30-day month)
#SPG = ln L2 - lnL1 / t2-t1
```{r}

# we want June to be t0 for both sites. We need to combine ASHC & FENC. To do this, first change the site name in June to initial to combined the data.
data_adjusted <- data_all %>%
  dplyr::mutate(Site = case_when(
   Month == "June" ~ "Initial",      # If Month is 6, set Site to "Initial"
    Site == "ASHC" ~ "ASHC",      # If Site is ASHC, keep ASHC
    TRUE ~ "FENC"                 # Otherwise, set Site to "FENC"
  ))
data_adjusted

#lets separate data sets by sites and rename "Initial" to the correct site (ASHC or FENC) for the data frame
ASHC_gr<- data_adjusted %>% filter(Site %in% c("ASHC", "Initial")) %>%   mutate(Site = ifelse(Site == "Initial", "ASHC", Site))
FENC_gr<- data_adjusted %>% filter(Site %in% c("FENC", "Initial"))%>%   mutate(Site = ifelse(Site == "Initial", "FENC", Site))


#Now that our data sets are adjusted we can rreate summary of height per bag per time period per site for each data set

st_height_bag_ASHC <- summarySE(ASHC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))
st_height_bag_FENC <- summarySE(FENC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Bag_number", "Month"))

 

#So we need to calculate how many days between each measurement to calculate the growth rate
# Sort data by site and sampling date (important if dates are not ordered)
st_height_bag_ASHC <- st_height_bag_ASHC %>%
  arrange(Site, Date, Bag_number)

st_height_bag_FENC <- st_height_bag_FENC %>%
  arrange(Site, Date, Bag_number)

# Calculate the number of days between sampling dates and the monthly growth rate per site per replicate
st_height_bag_ASHC <- st_height_bag_ASHC %>%
  group_by(Site, Bag_number) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = (H2-H1)/(Days_between))

st_height_bag_ASHC

st_height_bag_FENC <- st_height_bag_FENC %>%
  group_by(Site, Bag_number) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = (H2-H1)/(Days_between))

st_height_bag_FENC

# MONTHLY GROWTH RATE: Calculate the number of days between sampling dates and the monthly growth rate per site across all replicates

st_height_ASHC <- summarySE(ASHC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))
st_height_FENC <- summarySE(FENC_gr%>% filter(!is.na(Shell_length)), measurevar="Shell_length", groupvars=c("Site", "Date", "Month"))

 

st_height_ASHC <- st_height_ASHC %>%
  group_by(Site) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = (H2-H1)/(Days_between))
st_height_ASHC

st_height_FENC <- st_height_FENC %>%
  group_by(Site) %>%
  mutate(Days_between = c(NA, diff(Date)), H1 = lag(Shell_length), H2 = Shell_length, monthly_growth_rate = (H2-H1)/(Days_between))
st_height_FENC


#Combine ASHC & FENC 
growth_summary<-rbind(st_height_ASHC, st_height_FENC)

# TOTAL GROWTH RATE - growth rate across the entire sample period
growthrate <- st_height_ASHC  %>%
  group_by(Site) %>%
  summarise(datemax = max(Date), 
             datemin = min(Date),
             time.elapsed = datemax - datemin, 
             lengthmax = max(Shell_length), 
             lengthmin = min(Shell_length), 
             growthrate = (lengthmax-lengthmin)/as.numeric(time.elapsed)) %>%
  ungroup()
  
growthrate

#Need to standardize the time lapsed to 30 days???? 
#Interpolate shell length at 30-day intervals for each month separately


```
```{r}
#Average shell height per month per site
# In June we lost some of the data from fence creek causing this weird discrepancy in the data. We need to combine ASHC & FENC for June to be the "starting point". 
  

ggplot(data=growth_summary, aes(x=Month, y=Shell_length, group=Site, color = Site)) +
                 geom_point(position = position_dodge(width = 0.08))+
                  geom_line()+ #added position_dodge to be able to see the first points since they are the same
                  geom_errorbar(aes(ymin=Shell_length-se, ymax=Shell_length+se), width=.2, position=position_dodge(0.08)) +  
  # scale_color_manual(values=c("green4", "darkorange1"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs( x ="Month", y = "Mean Shell Height (mm)")+
  geom_label(label="t0", #adding time zero label
    x=1,
    y=33,
    label.padding = unit(0.3, "lines"), # Rectangle size around label
    label.size = 0.05,
    color = "darkgray",
    fill="white"
  )


#I would add a text box with "t0" next to the June points

```
#graphing growth rate
#this needs to be fixed/updated
```{r}
growth.rate <- ggplot(data=growth_summary, aes(x=Site, y=monthly_growth_rate, fill=Site)) +
  geom_boxplot(width = 2)+  #scale_fill_manual(values=c("forestgreen","orange", "purple"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_fill_manual(values = c("orange1", "cornflowerblue") )+
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(x ="Site", y = "Growth Rate (mm / month)") +
# could add a facet_wrap for date
  theme(axis.title = element_text(size = rel(1.7)), axis.text = element_text(size = rel(1.3)), plot.margin = margin(10, 150, 10, 150))+
  ylim(0,1)
  

growth.rate


ggplot(data=growth_summary, aes(x=Month, y=monthly_growth_rate, color=Site, group = Site)) +
                 geom_point()+ geom_line(size = 1) +
        #geom_errorbar(aes(ymin=Shell_length-se, ymax=Shell_length+se), width=.2, position=position_dodge(0)) +  
  # scale_color_manual(values=c("green4", "darkorange1"))+
  theme_bw() +  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ 
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs( x ="Month", y = "Growth Rate (mm/month") #+ facet_wrap(~Site, nrow = 2)

```



#Linear mixed effects models to look at size between sites over time
```{r}

#We want to use the below data sheets with the standardized t0 - combining 
ASHC_gr
FENC_gr

library(lme4)
library(car)

#Lets look at differences within sites - Is shell length significantly different over time? 

lme_size_ASHC <- lmer(Shell_length ~ Date + (1|Bag_number), ASHC_gr)
Anova(lme_size_ASHC)
summary(lme_size_ASHC)

lme_size_FENC <- lmer(Shell_length ~ Date + (1|Bag_number), FENC_gr)
Anova(lme_size_FENC)
summary(lme_size_ASHC)


#We want to compare between the sites as well - lets combine the data & run a model. Is there a significant difference in growth over time and between sites?
growth_master <- rbind(ASHC_gr, FENC_gr)

lme_size <- lmer(Shell_length ~ Date + Site + (1|Bag_number), growth_master)
Anova(lme_size)
summary(lme_size)

```
#Generalized Additive Models (https://m-clark.github.io/generalized-additive-models/introduction.html) to compare environmental data to growth
#https://cran.r-project.org/web/packages/gam/gam.pdf
```{r}
#Pull in environmental data - monthly means created in "Raw_Plotting.RMD" in the sonde code
CT_sonde<- read.csv("C:/Users/mariah.kachmar/documents/Github/EAD-ASEB_EPA_LISS_Disease_Surveillance/Sonde_Data/output/Sonde_monthly_means_CT.csv")%>% dplyr::mutate(
    year = year(year_month),
    Month = month(year_month, label = FALSE, abbr = FALSE)) %>% filter(`year_month` > '2024-05-01' & `year_month` < '2024-11-01' ) #filter what date ranges are needed
CT_sonde

#Seperate by variable 
pH_jg          <- CT_sonde %>% dplyr::filter(variable == 'pH' & Site %in% c('FENC', 'ASHC'))
Salinity_jg    <- CT_sonde %>% dplyr::filter(variable == 'Salinity' & Site %in% c('FENC', 'ASHC'))
Temperature_jg <- CT_sonde %>% dplyr::filter(variable == 'Temperature' & Site %in% c('FENC', 'ASHC'))
DO_jg          <- CT_sonde %>% dplyr::filter(variable == 'RDO Concentration' & Site %in% c('FENC', 'ASHC'))
CHLA_jg       <- CT_sonde %>% dplyr::filter(variable == 'Chlorophyll-a Fluorescence' & Site %in% c('FENC', 'ASHC'))

#before we conduct our models we will need to combine environmental data to our growth data
pH_merged <- pH_jg %>% inner_join(growth_master, by = c("Month", "Site"))
salinity_merged <- Salinity_jg %>% inner_join(growth_master, by = c("Month", "Site"))
temperature_merged <- Temperature_jg %>% inner_join(growth_master, by = c("Month", "Site"))
CHLA_merged <- CHLA_jg %>% inner_join(growth_master, by = c("Month", "Site"))
DO_merged <- DO_jg %>% inner_join(growth_master, by = c("Month", "Site"))


#library(gam)
#library(mgcv)

#Is the monthly means of each environmental parameter different between sites?

lme_ph <- lmer(mean ~ Site + (1 | Month), data = pH_jg) #No
Anova(lme_ph)

lme_temp <- lmer(mean ~ Site + (1 | Month), data = Temperature_jg) #No
Anova(lme_temp )

lme_salinity <- lmer(mean ~ Site + (1 | Month), data = Salinity_jg) #No
Anova(lme_salinity)

lme_CHLA <- lmer(mean ~ Site + (1 | Month), data = CHLA_jg) #Yes - was this important for growth at each site? 
Anova(lme_CHLA)

lme_DO <- lmer(mean ~ Site + (1 | Month), data = DO_jg) #No
Anova(lme_DO)

#gam_ph_jg <- gamm(Shell_length ~ mean + Site + Month, random = list(Bag_number = ~ 1), family =gaussian, pH_merged )
 
#gam() not working so I decided to try an lmer() since I used this in my perkinsus study to see if this works and it does but we should definitely talk about if this makes sense to use

#Thinking about the best way to set up this model - what is our big questions? 
#What are my assumptions? Shell length is our predicted variable (response). mean (of the environmental parameter) is hypothesized to influence shell length. Site is categorical and we want to assess site-specific impacts on shell length. Month and bag number are random effects. Month assumes that shell length varies by month and we want to account for month specific influences on shell height. Bag number is our experimental replicates and there may be variability among replicates. 
#Hypothesis: Shell length can be explained by mean environmental conditions, site differences, and random variation across months and bags. 
 
lme_ph_jg <- lmer(Shell_length ~ mean * Site +  (1|Month)+ (1 | Bag_number), data = pH_merged)
Anova(lme_ph_jg)
#Site is significant. Shell length differs between sites but pH does not have a detectable influence. However, the interaction (*) between site and pH is significant. So this is telling us that pH does impact shell growth but it is dependent on specific site conditions. 

lme_salinity_jg <- lmer(Shell_length ~ mean * Site  +  (1|Month)+ (1 | Bag_number), data = salinity_merged)
Anova(lme_salinity_jg)
#salinity and the interaction between site and salinity is significant. So salinity impacts growth and has site dependencies - salinity is interacting with other factors. 

lme_temp_jg <- lmer(Shell_length ~ mean * Site  +  (1|Month) + (1 | Bag_number), data = temperature_merged)
Anova(lme_temp_jg)
#Temperature is significant so it has a consistent effect  on growth across sites. Site differences in shell growth exist independently of temperature. 
#Is there a positive or negative relationship with temperature? positive - both growth and temperature increase. 
#The interaction of temperature and site was not significant so the sites do not vary

lme_CHLA_jg <- lmer(Shell_length ~ mean* Site  +  (1|Month) + (1 | Bag_number), data = CHLA_merged)
Anova(lme_CHLA_jg)
#CHLA influences shell growth but differently at each site - what is the food availability like between the sites (we know they are different from the model above)? We also know that the growth rate varies between sites - fence creek is larger. More food = more growth? 
#The interaction indicate that specific site interactions play a role with CHLA

lme_DO_jg <- lmer(Shell_length ~ mean * Site  +  (1|Month) + (1 | Bag_number), data = DO_merged)
Anova(lme_DO_jg)
#DO influences shell growth but differently at each site - How does DO differ between sites? The model above indicates there is not a significant difference so this shows us that DO is interacting with other factors at each site - CHLA & salinity? which is confirmed by the significant interaction between site and DO. 


#So, what do we know? CHLA is different at each site - one has more food availability than the other. All environmental conditions interact to influence the differences in shell height/growth at each site- aka the combine environmental factors create differences between sites. pH does not impact growth alone and temperature is independent of site (so the same trend is happening at both) with positive relationships with shell length - as temperature increases so does shell length/growth.  

```

#Kaplan Meier Survival curves, log rank tests, and cox proportional hazard analysis
#The Kaplan-Meier method is a non-parametric approach that's commonly used to analyze time-to-event data, such as the time until death or a specific event. It's a straightforward way to estimate survival rates and probabilities by tabulating and discussing the results
```{r}

#View(ASHC)
#View(FENC)

#we want to use the original data set here because it accounted for the individiuals even with lost height data

#Lets take a look at each site separately first to see what is going on 

#We can look at the data by each site only
# Create a survival object per bag and plot 
ASHC$Survival <-as.numeric(ASHC$Survival) #need to make sure everything is in numeric format
ASHC$Month <-as.numeric(ASHC$Month)
FENC$Survival <-as.numeric(FENC$Survival) #need to make sure everything is in numeric format
FENC$Month <-as.numeric(FENC$Month)

# Ash Creek survival by bag
Surv_ASHC <- Surv(time = ASHC$Month, event = ASHC$Survival) #create your survival object using surv()
fit.surv_ASHC <- survfit(formula = Surv_ASHC ~ Bag_number, data = ASHC) #Computes an estimate of a survival curve from the survival object

ASHC_survival_plot<-ggsurvplot(fit.surv_ASHC, data = ASHC, , conf.int = TRUE, break.x.by = 1,
           linetype= c(1, 2, 3),xlab = "Month", ylab= "Survival", xlim = c(5,10), legend.labs= c("bag 1", "bag 2",
                                                                 "bag 3"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Ash Creek, CT")
ASHC_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"ASHC_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(ASHC_survival_plot) #specify the graph
dev.off()


# Fence Creek survival
Surv_FENC <- Surv(time = FENC$Month, event = FENC$Survival) #create your survival object using surv()
fit.surv_FENC <- survfit(formula = Surv_FENC ~ Bag_number, data = FENC) #Computes an estimate of a survival curve from the survival object

FENC_survival_plot<-ggsurvplot(fit.surv_FENC, data = FENC,break.x.by = 1,
           linetype= c(1, 2, 3),xlab = "Month", ylab= "Survival", xlim = c(5,10), legend.labs= c("bag 1", "bag 2",
                                                                 "bag 3"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Fence Creek, CT") 
FENC_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"FENC_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(FENC_survival_plot) #specify the graph
dev.off()


###########Survival comparing sites - this is what we will report in our manuscript.##################

data_all$Month<-as.numeric(data_all$Month)
data_all$Survival<-as.numeric(data_all$Survival)

Surv_CT <- Surv(time = data_all$Month, event = data_all$Survival) #create your survival object using surv(). The survival object is the estimated survival function showing the probability of surviving beyond a certain point
fit.surv_CT <- survfit(formula = Surv_CT ~ Site, data = data_all) #Computes an estimate of a survival curve from the survival object

CT_survival_plot<-ggsurvplot(fit.surv_CT, data = data_all,  conf.int = TRUE, break.x.by = 1,
           linetype= c(1, 2),xlab = "Month", ylab= "Survival", xlim = c(5,10), legend.labs= c("Ash Creek", "Fence Creek"),
           legend.title = "Replicate:", legend = "top", risk.table =FALSE )+ theme_survminer(base_size = 20,font.legend = c(15))+ggtitle("Survival between Ash Creek, CT and Fence Creek, CT")
CT_survival_plot

#output of graph
pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"JuvGrowth_Kaplan_Survival.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(CT_survival_plot) #specify the graph
dev.off()


#Statistics
#Pairwise comparisons using long rank tests
#H: There is a significant difference in survival between sites
pc_site <- pairwise_survdiff(Surv(Month, Survival)~ Site, data = data_all)
pc_site

#Chi sq values
surv_diff_site<-survdiff(Surv(Month, Survival) ~ Site, data = data_all)
surv_diff_site

## Survival probability for all of sites & bags
summary(survfit(Surv(Month, Survival) ~ Site, data = data_all))
summary(survfit(Surv(Month, Survival) ~ Site + Bag_number, data = data_all))


#Cox proportional hazard - estimates how various factors affect the time it takes for an event to occur. The model's main output is a hazard rate (HR) that can be used to generate survival curves for groups or individuals within a population
fit.coxph <- coxph(Surv_CT ~ Site, data = data_all)
fit.coxph
jg_coxph<-ggforest(fit.coxph, data = data_all, fontsize = 1.5)
jg_coxph

pdf(paste0(path = "Side_projects/Juvenile_growth/outputs/" ,"jg_coxph.pdf"), height = 7, width = 11) #printing a PDF within the path of the code, with specific dimensions of PDF
print(jg_coxph) #specify the graph
dev.off()

```





```{r}
sessionInfo()
```


